name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip npm publish)'
        required: false
        default: 'false'
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm install --ignore-scripts || true
      - name: Test marshal fixtures
        run: node scripts/run-marshal-fixtures.js
      - name: Test marshal ambiguity guard
        run: node scripts/run-marshal-ambiguity.js

      # Core modern features tests (blocking)
      - name: Test exception groups (3.11+)
        run: node scripts/run-matrix.js --pattern py311_exception_groups --fail-fast
      - name: Test f-strings
        run: node scripts/run-matrix.js --pattern py36_fstrings --fail-fast
      - name: Test walrus operator
        run: node scripts/run-matrix.js --pattern py38_walrus --fail-fast
      - name: Test match patterns (3.12)
        run: node scripts/run-fixtures.js --root test/bytecode_3.12 --pattern py310_match --fail-fast
      - name: Test 3.14 features
        run: |
          node scripts/run-matrix.js --pattern py314_formatting --fail-fast
          node scripts/run-matrix.js --pattern py314_with --fail-fast

  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Verify package.json version matches tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: package.json version ($PKG_VERSION) does not match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Publish to npm
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Dry run - skip publish
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "Dry run mode - skipping npm publish"
          npm pack --dry-run

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.version }}
          body: |
            ## depyo v${{ steps.version.outputs.version }}

            Python bytecode decompiler (1.0â€“3.14) in Node.js.

            ### Install
            ```bash
            npm install -g depyo
            # or
            npx depyo <file.pyc>
            ```

            See [README](https://github.com/skuznetsov/depyo.js#readme) for full documentation.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
